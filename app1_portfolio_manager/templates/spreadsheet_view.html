{% extends "base.html" %}

{% block title %}{{ portfolio.name }} - Spreadsheet View{% endblock %}

{% block extra_head %}
<!-- Handsontable CSS - Open Source Spreadsheet Library -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@13.1.0/dist/handsontable.full.min.css">
<style>
    body {
        background-color: #f5f5f5;
    }
    
    .handsontable-container {
        overflow: auto;
        max-height: calc(100vh - 300px);
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    /* Excel-style Yellow Headers */
    .handsontable thead th {
        background: linear-gradient(to bottom, #FFFF00 0%, #F4E600 100%) !important;
        color: #000000 !important;
        font-weight: bold !important;
        border: 1px solid #999 !important;
        text-align: center !important;
        vertical-align: middle !important;
        padding: 8px 4px !important;
        font-size: 11px !important;
    }
    
    /* Stage Group Headers */
    .stage-group-header {
        background: linear-gradient(to bottom, #FFFF00 0%, #FFD700 100%) !important;
        font-weight: bold !important;
        font-size: 12px !important;
        border: 2px solid #888 !important;
    }
    
    /* Green Discipline Rows - matching Excel */
    .discipline-row {
        background: linear-gradient(to bottom, #92D050 0%, #7AB839 100%) !important;
        font-weight: bold !important;
        color: #000000 !important;
        font-size: 12px !important;
    }
    
    .discipline-row td {
        background: linear-gradient(to bottom, #92D050 0%, #7AB839 100%) !important;
        border: 1px solid #6B9E30 !important;
    }
    
    /* Data cells */
    .handsontable td {
        border: 1px solid #d0d0d0 !important;
        font-size: 11px !important;
        padding: 4px !important;
    }
    
    /* Row numbers */
    .handsontable tbody th {
        background: #f0f0f0 !important;
        font-weight: normal !important;
        border: 1px solid #ccc !important;
    }
    
    /* Selected cells */
    .handsontable td.current,
    .handsontable th.current {
        background-color: #E3F2FD !important;
    }
    
    /* Editable cells highlight */
    .handsontable td.area {
        background-color: #BBDEFB !important;
    }
    
    .toolbar {
        margin-bottom: 20px;
        padding: 15px;
        background: linear-gradient(to bottom, #ffffff 0%, #f8f9fa 100%);
        border-radius: 8px;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .toolbar .btn {
        margin-right: 10px;
        font-weight: 500;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .save-indicator {
        display: none;
        color: #28a745;
        margin-left: 15px;
        font-weight: 500;
        animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .save-indicator.saving {
        color: #ffc107;
    }
    
    .save-indicator.error {
        color: #dc3545;
    }
    
    .save-indicator i {
        font-size: 1.1em;
    }
    
    /* Info alert styling */
    .alert-info {
        background: linear-gradient(to bottom, #D1ECF1 0%, #BEE5EB 100%);
        border-color: #17a2b8;
        border-radius: 8px;
    }
    
    .alert-info strong {
        color: #0c5460;
    }
    
    /* Header section */
    .page-header {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .page-header h1 {
        color: #2c3e50;
        margin-bottom: 5px;
    }
    
    .page-header p {
        color: #6c757d;
        font-size: 14px;
    }
    
    /* Button styling */
    .btn-group-custom {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    /* Scrollbar styling */
    .handsontable-container::-webkit-scrollbar {
        width: 12px;
        height: 12px;
    }
    
    .handsontable-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    .handsontable-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }
    
    .handsontable-container::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    
    /* Loading indicator */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    .loading-overlay.show {
        display: flex;
    }
    
    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Stage column grouping visual */
    .handsontable th[colspan] {
        background: linear-gradient(to bottom, #FFFF00 0%, #FFB300 100%) !important;
        font-size: 13px !important;
        font-weight: bold !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay show">
    <div class="text-center">
        <div class="spinner"></div>
        <p class="text-white mt-3 fw-bold fs-5">Loading Master Document Register...</p>
    </div>
</div>

<!-- Page Header -->
<div class="page-header">
    <div class="d-flex justify-content-between align-items-start flex-wrap">
        <div>
            <h1>
                <i class="bi bi-file-earmark-spreadsheet text-success"></i> 
                Master Document Register
            </h1>
            <p class="mb-1">
                <strong>Portfolio:</strong> <span class="text-primary">{{ portfolio.name }}</span> &nbsp;|&nbsp; 
                <strong>Code:</strong> <span class="text-info">{{ portfolio.code }}</span> &nbsp;|&nbsp; 
                <strong>Client:</strong> {{ portfolio.client or 'N/A' }}
            </p>
            <p class="text-muted small mb-0">
                <i class="bi bi-calendar3"></i> Created: {{ portfolio.created_at.strftime('%d %B %Y') if portfolio.created_at else 'N/A' }}
            </p>
        </div>
        <div class="btn-group-custom">
            <a href="{{ url_for('view_portfolio', portfolio_id=portfolio.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to List View
            </a>
            <a href="{{ url_for('export_excel', portfolio_id=portfolio.id) }}" class="btn btn-success">
                <i class="bi bi-file-earmark-excel"></i> Export to Excel
            </a>
        </div>
    </div>
</div>

<!-- Toolbar -->
<div class="toolbar">
    <div class="d-flex justify-content-between align-items-center flex-wrap">
        <div class="d-flex align-items-center flex-wrap">
            <button id="saveBtn" class="btn btn-primary btn-lg" onclick="saveAllChanges()">
                <i class="bi bi-floppy"></i> Save All Changes
            </button>
            <button class="btn btn-info" onclick="refreshData()">
                <i class="bi bi-arrow-clockwise"></i> Refresh Data
            </button>
            <span id="saveIndicator" class="save-indicator">
                <i class="bi bi-check-circle-fill"></i> <span id="saveText">Saved</span>
            </span>
        </div>
        <div>
            <span class="badge bg-primary me-2">
                <i class="bi bi-file-text"></i> <span id="totalDocs">0</span> Documents
            </span>
            <span class="badge bg-success">
                <i class="bi bi-folder"></i> <span id="totalDisciplines">0</span> Disciplines
            </span>
        </div>
    </div>
</div>

<!-- Instructions -->
<div class="alert alert-info shadow-sm">
    <h6 class="alert-heading mb-2">
        <i class="bi bi-info-circle-fill"></i> Spreadsheet Controls
    </h6>
    <div class="row gx-4">
        <div class="col-md-3">
            <strong><i class="bi bi-pencil-square"></i> Edit:</strong> Click any white cell
        </div>
        <div class="col-md-3">
            <strong><i class="bi bi-keyboard"></i> Navigate:</strong> Arrow keys / Tab
        </div>
        <div class="col-md-3">
            <strong><i class="bi bi-clipboard"></i> Copy/Paste:</strong> Ctrl+C / Ctrl+V
        </div>
        <div class="col-md-3">
            <strong style="background:#92D050; padding:2px 6px; border-radius:3px; color:#000;">GREEN:</strong> Read-only disciplines
        </div>
    </div>
</div>

<!-- Spreadsheet Container -->
<div id="spreadsheet" class="handsontable-container"></div>

<!-- Handsontable JS -->
<script src="https://cdn.jsdelivr.net/npm/handsontable@13.1.0/dist/handsontable.full.min.js"></script>

<script>
    const portfolioId = {{ portfolio.id }};
    let hotInstance;
    let changedCells = new Set();
    
    // Stage configuration
    const stages = [
        { code: 'IFR', hasNextRev: false },
        { code: 'IFH', hasNextRev: true },
        { code: 'IFD', hasNextRev: true },
        { code: 'IFT', hasNextRev: true },
        { code: 'IFP', hasNextRev: true },
        { code: 'IFA', hasNextRev: true },
        { code: 'IFC', hasNextRev: true },
        { code: 'AFC', hasNextRev: false }
    ];
    
    // Build column structure
    function buildColumns() {
        const columns = [
            { data: 's_no', title: 'S/No', width: 50, readOnly: true },
            { data: 'doc_number', title: 'Doc Number', width: 120 },
            { data: 'doc_title', title: 'Document Title', width: 300 },
            { data: 'current_revision', title: 'Current Rev', width: 100 },
            { data: 'current_status', title: 'Status', width: 120 },
            { data: 'current_transmittal_no', title: 'Current TR No', width: 120 }
        ];
        
        // Add columns for each stage
        stages.forEach(stage => {
            const stageCode = stage.code.toLowerCase();
            
            // Submission columns
            columns.push(
                { data: `${stageCode}_date_planned`, title: `${stage.code} Planned`, width: 100 },
                { data: `${stageCode}_date_actual`, title: `${stage.code} Actual`, width: 100 },
                { data: `${stageCode}_tr_no`, title: `${stage.code} TR No`, width: 100 },
                { data: `${stageCode}_date_sent`, title: `${stage.code} Sent`, width: 100 },
            );
            
            // Feedback columns
            columns.push(
                { data: `${stageCode}_rev_status`, title: `${stage.code} Rev Status`, width: 100 },
                { data: `${stageCode}_issue_for`, title: `${stage.code} Issue For`, width: 120 },
                { data: `${stageCode}_date_received`, title: `${stage.code} Received`, width: 100 },
                { data: `${stageCode}_tr_received`, title: `${stage.code} TR Received`, width: 120 }
            );
            
            // Next Rev (if applicable)
            if (stage.hasNextRev) {
                columns.push({ data: `${stageCode}_next_rev`, title: `${stage.code} Next Rev`, width: 100 });
            }
        });
        
        // Remarks
        columns.push({ data: 'remarks', title: 'Remarks', width: 200 });
        
        return columns;
    }
    
    // Fetch data from server
    async function fetchData() {
        try {
            const response = await fetch(`/api/portfolios/${portfolioId}/spreadsheet-data`);
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching data:', error);
            alert('Error loading spreadsheet data');
            return [];
        }
    }
    
    // Initialize spreadsheet
    async function initSpreadsheet() {
        const data = await fetchData();
        const container = document.getElementById('spreadsheet');
        const columns = buildColumns();
        
        hotInstance = new Handsontable(container, {
            data: data,
            columns: columns,
            colHeaders: columns.map(c => c.title),
            rowHeaders: true,
            width: '100%',
            height: 'auto',
            licenseKey: 'non-commercial-and-evaluation',
            stretchH: 'none',
            autoWrapRow: true,
            autoWrapCol: true,
            manualColumnResize: true,
            manualRowResize: true,
            contextMenu: true,
            filters: true,
            dropdownMenu: true,
            
            // Custom cell renderer for discipline rows
            cells: function(row, col) {
                const cellProperties = {};
                const rowData = this.instance.getSourceDataAtRow(row);
                
                // Check if this is a discipline header row
                // Discipline rows have is_discipline_header: true in the data
                if (rowData && rowData.is_discipline_header) {
                    cellProperties.readOnly = true;
                    cellProperties.className = 'discipline-row';
                }
                
                return cellProperties;
            },
            
            // Track changes
            afterChange: function(changes, source) {
                if (source !== 'loadData' && changes) {
                    changes.forEach(([row, prop, oldValue, newValue]) => {
                        if (oldValue !== newValue) {
                            changedCells.add(`${row}-${prop}`);
                            document.getElementById('saveBtn').classList.add('btn-warning');
                            document.getElementById('saveBtn').classList.remove('btn-primary');
                            document.getElementById('saveBtn').innerHTML = '<i class="bi bi-exclamation-circle"></i> Save Changes (' + changedCells.size + ')';
                        }
                    });
                }
            }
        });
        
        // Update statistics
        updateStatistics(data);
        
        // Hide loading overlay
        document.getElementById('loadingOverlay').classList.remove('show');
        
        console.log('✅ Spreadsheet initialized with', data.length, 'rows');
    }
    
    // Update statistics display
    function updateStatistics(data) {
        const disciplineCount = data.filter(row => row.is_discipline_header).length;
        const documentCount = data.filter(row => !row.is_discipline_header).length;
        
        document.getElementById('totalDocs').textContent = documentCount;
        document.getElementById('totalDisciplines').textContent = disciplineCount;
    }
    
    // Save all changes
    async function saveAllChanges() {
        if (changedCells.size === 0) {
            alert('No changes to save');
            return;
        }
        
        const data = hotInstance.getData();
        const sourceData = hotInstance.getSourceData();
        
        const saveIndicator = document.getElementById('saveIndicator');
        const saveText = document.getElementById('saveText');
        const saveBtn = document.getElementById('saveBtn');
        
        saveIndicator.style.display = 'inline';
        saveIndicator.className = 'save-indicator saving';
        saveText.textContent = 'Saving...';
        saveBtn.disabled = true;
        
        try {
            const response = await fetch(`/api/portfolios/${portfolioId}/update-spreadsheet`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ documents: sourceData })
            });
            
            if (response.ok) {
                const result = await response.json();
                saveIndicator.className = 'save-indicator';
                saveText.textContent = `✓ Saved ${result.updated} documents successfully!`;
                saveBtn.classList.remove('btn-warning');
                saveBtn.classList.add('btn-success');
                saveBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> All Saved!';
                changedCells.clear();
                
                setTimeout(() => {
                    saveIndicator.style.display = 'none';
                    saveBtn.classList.remove('btn-success');
                    saveBtn.classList.add('btn-primary');
                    saveBtn.innerHTML = '<i class="bi bi-floppy"></i> Save All Changes';
                }, 3000);
            } else {
                throw new Error('Save failed');
            }
        } catch (error) {
            console.error('Error saving:', error);
            saveIndicator.className = 'save-indicator error';
            saveText.textContent = 'Error saving!';
            alert('Error saving changes. Please try again.');
        } finally {
            saveBtn.disabled = false;
        }
    }
    
    // Refresh data
    async function refreshData() {
        if (changedCells.size > 0) {
            if (!confirm('You have unsaved changes. Refresh anyway?')) {
                return;
            }
        }
        
        // Show loading
        document.getElementById('loadingOverlay').classList.add('show');
        
        const data = await fetchData();
        hotInstance.loadData(data);
        changedCells.clear();
        
        // Update UI
        document.getElementById('saveBtn').classList.remove('btn-warning');
        document.getElementById('saveBtn').classList.add('btn-primary');
        document.getElementById('saveBtn').innerHTML = '<i class="bi bi-floppy"></i> Save All Changes';
        
        // Update statistics
        updateStatistics(data);
        
        // Hide loading
        document.getElementById('loadingOverlay').classList.remove('show');
        
        // Show success
        const saveIndicator = document.getElementById('saveIndicator');
        const saveText = document.getElementById('saveText');
        saveIndicator.style.display = 'inline';
        saveText.textContent = 'Data refreshed!';
        setTimeout(() => {
            saveIndicator.style.display = 'none';
        }, 3000);
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', initSpreadsheet);
    
    // Warn on page leave if there are unsaved changes
    window.addEventListener('beforeunload', function(e) {
        if (changedCells.size > 0) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            return e.returnValue;
        }
    });
</script>
{% endblock %}

